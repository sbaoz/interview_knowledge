# åŸç†-è°ƒå’Œä¸fiber

- ä»€ä¹ˆæ˜¯fiber  
  fiberè¯ç”Ÿåœ¨Reactv16ç‰ˆæœ¬ ç›®çš„æ˜¯è§£å†³å¤§å‹Reactåº”ç”¨å¡é¡¿çš„é—®é¢˜ fiberåœ¨Reactä¸­å¼æœ€å°ç²’åº¦çš„æ‰§è¡Œå•ä½ æ— è®ºReactè¿˜æ˜¯Vue åœ¨éå†æ›´æ–°æ¯ä¸ªèŠ‚ç‚¹çš„æ—¶å€™éƒ½ä¸æ˜¯ç”¨çš„çœŸå®DOM éƒ½æ˜¯é‡‡ç”¨è™šæ‹ŸDOM å¯ä»¥ç†è§£æˆfiberå°±æ˜¯Reactçš„è™šæ‹ŸDOM  
- ä¸ºä»€ä¹ˆè¦ç”¨fiber  
  åœ¨Reactv15ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ Reactå¯¹äºè™šæ‹ŸDOMæ˜¯é‡‡ç”¨é€’å½’æ–¹å¼éå†æ›´æ–°çš„ ä¸€æ¬¡æ›´æ–°å°±ä¼šä»åº”ç”¨æ ¹éƒ¨é€’å½’æ›´æ–° é€’å½’ä¸€æ—¦å¼€å§‹ ä¸­é€”æ— æ³•ä¸­æ–­ éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ å±‚çº§è¶Šæ¥è¶Šæ·± å¯¼è‡´æ›´æ–°çš„æ—¶é—´è¶Šæ¥è¶Šé•¿ äº¤äº’ä¸Šä¼šå‡ºç°å¡é¡¿  
  Reactv16ä¸ºäº†è§£å†³å¡é¡¿é—®é¢˜å¼•å…¥äº†fiberï¼Œæ›´æ–°fiberçš„è¿‡ç¨‹å«åšReconciler(è°ƒå’Œå™¨) æ¯ä¸ªfiberéƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªæ‰§è¡Œå•å…ƒæ¥å¤„ç† æ¯ä¸ªfiberå¯ä»¥æ ¹æ®è‡ªèº«çš„expirationTime(è¿‡æœŸæ—¶é—´) v17ç‰ˆæœ¬ä¸­å«lane(ä¼˜å…ˆçº§) æ¥åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—²æ—¶é—´æ‰§è¡Œæ›´æ–° å¦‚æœæ²¡æœ‰æ—¶é—´æ›´æ–° å°±æŠŠä¸»åŠ¨æƒäº¤ç»™æµè§ˆå™¨å»æ¸²æŸ“ åšä¸€äº›åŠ¨ç”» é‡æ’ é‡ç»˜ è¿™æ ·å°±èƒ½è§£å†³äº¤äº’å¡é¡¿çš„é—®é¢˜ ç­‰åˆ°æµè§ˆå™¨æœ‰ç©ºä½™æ—¶é—´ å†é€šè¿‡scheduler(è°ƒåº¦å™¨) å†æ¬¡æ¢å¤æ‰§è¡Œæ›´æ–°  

### å…¨é¢è®¤è¯†fiber  
- element fiber domä¸‰è€…çš„å…³ç³»  
  - elementæ˜¯Reactè§†å›¾å±‚åœ¨ä»£ç å±‚çº§ä¸Šçš„è¡¨è±¡ ä¹Ÿå°±æ˜¯jsxå†™çš„å…ƒç´ éƒ½ä¼šè¢«åˆ›å»ºæˆelementå¯¹è±¡çš„å½¢å¼ ä¸Šé¢ä¿å­˜äº†props childrenç­‰ä¿¡æ¯  
  - DOMæ˜¯å…ƒç´ åœ¨æµè§ˆå™¨ä¸Šçš„è¡¨è±¡  
  - fiberæ˜¯elementå’ŒDOMä¹‹é—´çš„æ¢çº½ æ¯ä¸€ä¸ªç±»å‹çš„elementéƒ½ä¼šä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„fiberç±»å‹ elementå˜åŒ–å¼•èµ·æ›´æ–°æµç¨‹éƒ½æ˜¯é€šè¿‡fiberå±‚é¢åšä¸€æ¬¡è°ƒå’Œæ”¹å˜ ç„¶åå½¢æˆæ–°çš„DOMåšè§†å›¾æ¸²æŸ“  

elementä¸fiberä¹‹é—´çš„å¯¹åº”å…³ç³»  
```javascript
export const FunctionComponent = 0;       // å¯¹åº”å‡½æ•°ç»„ä»¶
export const ClassComponent = 1;          // å¯¹åº”çš„ç±»ç»„ä»¶
export const IndeterminateComponent = 2;  // åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ 
export const HostRoot = 3;                // Root Fiber å¯ä»¥ç†è§£ä¸ºè·Ÿå…ƒç´  ï¼Œ é€šè¿‡reactDom.render()äº§ç”Ÿçš„æ ¹å…ƒç´ 
export const HostPortal = 4;              // å¯¹åº”  ReactDOM.createPortal äº§ç”Ÿçš„ Portal 
export const HostComponent = 5;           // dom å…ƒç´  æ¯”å¦‚ <div>
export const HostText = 6;                // æ–‡æœ¬èŠ‚ç‚¹
export const Fragment = 7;                // å¯¹åº” <React.Fragment> 
export const Mode = 8;                    // å¯¹åº” <React.StrictMode>   
export const ContextConsumer = 9;         // å¯¹åº” <Context.Consumer>
export const ContextProvider = 10;        // å¯¹åº” <Context.Provider>
export const ForwardRef = 11;             // å¯¹åº” React.ForwardRef
export const Profiler = 12;               // å¯¹åº” <Profiler/ >
export const SuspenseComponent = 13;      // å¯¹åº” <Suspense>
export const MemoComponent = 14;          // å¯¹åº” React.memo è¿”å›çš„ç»„ä»¶
```

- fiberä¿å­˜çš„ä¿¡æ¯  
  > react-reconciler/src/ReactFiber.js
  ```javascript
  function FiberNode(){

    this.tag = tag;                  // fiber æ ‡ç­¾ è¯æ˜æ˜¯ä»€ä¹ˆç±»å‹fiberã€‚
    this.key = key;                  // keyè°ƒå’Œå­èŠ‚ç‚¹æ—¶å€™ç”¨åˆ°ã€‚ 
    this.type = null;                // domå…ƒç´ æ˜¯å¯¹åº”çš„å…ƒç´ ç±»å‹ï¼Œæ¯”å¦‚divï¼Œç»„ä»¶æŒ‡å‘ç»„ä»¶å¯¹åº”çš„ç±»æˆ–è€…å‡½æ•°ã€‚  
    this.stateNode = null;           // æŒ‡å‘å¯¹åº”çš„çœŸå®domå…ƒç´ ï¼Œç±»ç»„ä»¶æŒ‡å‘ç»„ä»¶å®ä¾‹ï¼Œå¯ä»¥è¢«refè·å–ã€‚
    
    this.return = null;              // æŒ‡å‘çˆ¶çº§fiber
    this.child = null;               // æŒ‡å‘å­çº§fiber
    this.sibling = null;             // æŒ‡å‘å…„å¼Ÿfiber 
    this.index = 0;                  // ç´¢å¼•

    this.ref = null;                 // refæŒ‡å‘ï¼Œrefå‡½æ•°ï¼Œæˆ–è€…refå¯¹è±¡ã€‚

    this.pendingProps = pendingProps;// åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œä»£è¡¨elementåˆ›å»º
    this.memoizedProps = null;       // è®°å½•ä¸Šä¸€æ¬¡æ›´æ–°å®Œæ¯•åçš„props
    this.updateQueue = null;         // ç±»ç»„ä»¶å­˜æ”¾setStateæ›´æ–°é˜Ÿåˆ—ï¼Œå‡½æ•°ç»„ä»¶å­˜æ”¾
    this.memoizedState = null;       // ç±»ç»„ä»¶ä¿å­˜stateä¿¡æ¯ï¼Œå‡½æ•°ç»„ä»¶ä¿å­˜hooksä¿¡æ¯ï¼Œdomå…ƒç´ ä¸ºnull
    this.dependencies = null;        // contextæˆ–æ˜¯æ—¶é—´çš„ä¾èµ–é¡¹

    this.mode = mode;                //æè¿°fiberæ ‘çš„æ¨¡å¼ï¼Œæ¯”å¦‚ ConcurrentMode æ¨¡å¼

    this.effectTag = NoEffect;       // effectæ ‡ç­¾ï¼Œç”¨äºæ”¶é›†effectList
    this.nextEffect = null;          // æŒ‡å‘ä¸‹ä¸€ä¸ªeffect

    this.firstEffect = null;         // ç¬¬ä¸€ä¸ªeffect
    this.lastEffect = null;          // æœ€åä¸€ä¸ªeffect

    this.expirationTime = NoWork;    // é€šè¿‡ä¸åŒè¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œ åœ¨v17ç‰ˆæœ¬ç”¨laneè¡¨ç¤ºã€‚

    this.alternate = null;           //åŒç¼“å­˜æ ‘ï¼ŒæŒ‡å‘ç¼“å­˜çš„fiberã€‚æ›´æ–°é˜¶æ®µï¼Œä¸¤é¢—æ ‘äº’ç›¸äº¤æ›¿ã€‚
    }
  ```

- fiberä¹‹é—´å¦‚ä½•å»ºç«‹èµ·å…³è”  
  fiberæ˜¯é€šè¿‡return child siblingä¸‰ä¸ªå±æ€§å»ºç«‹èµ·è”ç³»çš„  
  - return æŒ‡å‘çˆ¶çº§  
  - child æŒ‡å‘å­èŠ‚ç‚¹  
  - sibling æŒ‡å‘å…„å¼ŸèŠ‚ç‚¹
  
### fiberæ›´æ–°æœºåˆ¶  
æ¯”å¦‚é¡¹ç›®å…ƒç´ ç»“æ„æ˜¯è¿™æ ·çš„  
```javascript
export default class Index extends React.Component{
   state={ number:666 } 
   handleClick=()=>{
     this.setState({
         number:this.state.number + 1
     })
   }
   render(){
     return <div>
       helloï¼Œworld
       <p > ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹ { this.state.number } ğŸ‘  </p>
       <button onClick={ this.handleClick } >ç‚¹èµ</button>
     </div>
   }
}
```
- åˆå§‹åŒ–  
  1. åˆ›å»ºfiberRootå’ŒRootFiber  
     - fiberRoot é¦–æ¬¡æ„å»ºåº”ç”¨ åˆ›å»ºä¸€ä¸ªfiberRoot ä½œä¸ºæ•´ä¸ªReactåº”ç”¨çš„æ ¹åŸº  
     - rootFiber é€šè¿‡ReactDOM.renderæ¸²æŸ“å‡ºæ¥çš„åº”ç”¨èŠ‚ç‚¹ ä¸€ä¸ªReactåº”ç”¨å¯ä»¥æœ‰å¤šä¸ªrootFiber ä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªfiberRoot  
    ç¬¬ä¸€æ¬¡æŒ‚è½½çš„è¿‡ç¨‹ä¸­ ä¼šå°†fiberRootå’ŒrootFiberå»ºç«‹èµ·å…³è”  
    > react-reconciler/src/ReactFiberRoot.js
    ```javascript
    function createFiberRoot(containerInfo,tag){
        /* åˆ›å»ºä¸€ä¸ªroot */
        const root = new FiberRootNode(containerInfo,tag)
        const rootFiber = createHostRootFiber(tag);
        root.current = rootFiber
        return root
    }
    ```
    ![iberæ›´æ–°æœºåˆ¶01](./images/fiberæ›´æ–°æœºåˆ¶01.png)
  2. workInProgresså’Œcurrent  
     ç»è¿‡ç¬¬ä¸€æ­¥çš„å¤„ç† å¼€å§‹åˆ°æ­£å¼æ¸²æŸ“é˜¶æ®µ ä¼šè¿›å…¥beginworkæµç¨‹ é¦–å…ˆæ˜ç™½ä¸¤ä¸ªæ¦‚å¿µ  
     - workInProgressï¼šæ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„fiberæ ‘ç§°ä¸ºworkInProgressæ ‘ åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯å‘ç”Ÿåœ¨workInProgressæ ‘ä¸Š åœ¨ä¸€æ¬¡æ›´æ–°ä¹‹å workInProgressæ ‘ä¸Šçš„çŠ¶æ€æ—¶æœ€æ–°çš„çŠ¶æ€ é‚£ä¹ˆå®ƒå°†å˜æˆcurrentæ ‘ç”¨äºæ¸²æŸ“è§†å›¾  
     - currentï¼šæ­£åœ¨è§†å›¾å±‚æ¸²æŸ“çš„æ ‘å«åšcurrentæ ‘  
     rootFiberæ¸²æŸ“çš„æµç¨‹ é¦–å…ˆä¼šå¤ç”¨å½“å‰currentæ ‘çš„alternateä½œä¸ºworkInProgress å¦‚æœæ²¡æœ‰alternateï¼ˆåˆå§‹åŒ–çš„rootFiberæ²¡æœ‰alternateï¼‰ é‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ªfiberä½œä¸ºworkInProgress ä¼šç”¨alternateå°†æ–°åˆ›å»ºçš„workInProgressä¸currentæ ‘å»ºç«‹å…³è” è¿™ä¸ªå…³è”è¿‡ç¨‹åªæœ‰åˆå§‹åŒ–ç¬¬ä¸€æ¬¡åˆ›å»ºalternateæ—¶è¿›è¡Œ  
     ```javascript
     currentFiber.alternate = workInProgressFiber
     workInProgressFiber.alternate = currentFiber
     ```
    ![iberæ›´æ–°æœºåˆ¶02](./images/fiberæ›´æ–°æœºåˆ¶02.png)  
  3. æ·±åº¦è°ƒå’Œå­èŠ‚ç‚¹ æ¸²æŸ“è§†å›¾  
     æ¥ä¸‹æ¥ä¼šåœ¨æ–°åˆ›å»ºçš„alternateä¸Šå®Œæˆæ•´ä¸ªfiberæ ‘çš„éå† åŒ…æ‹¬fiberçš„åˆ›å»º  
    ![iberæ›´æ–°æœºåˆ¶03](./images/fiberæ›´æ–°æœºåˆ¶03.png)  
     æœ€åä¼šä»¥workInProgressä½œä¸ºæœ€æ–°çš„æ¸²æŸ“æ ‘ fiberRootçš„currentæŒ‡é’ˆæŒ‡å‘workInProgressä½¿å…¶å˜æˆcurrentæ ‘ åˆ°æ­¤å®Œæˆåˆå§‹åŒ–æµç¨‹  
    ![iberæ›´æ–°æœºåˆ¶04](./images/fiberæ›´æ–°æœºåˆ¶04.png)  

- æ›´æ–°  
  å¯¹äºä¸Šè¿°demo ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®å‘ç”Ÿæ›´æ–° é¦–å…ˆä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªworkInProgressæ ‘ å¤ç”¨å½“å‰currentæ ‘ä¸Šçš„alternate ä½œä¸ºæ–°çš„workInProgress åˆå§‹åŒ–rootfiberæœ‰alternate å¯¹äºå‰©ä½™çš„å­èŠ‚ç‚¹ è¿˜éœ€è¦åˆ›å»ºä¸€ä»½ å’Œcurrentæ ‘ä¸Šçš„fiberå»ºç«‹èµ·alternateå…³è” æ¸²æŸ“å®Œæ¯•å workInProgresså†æ¬¡å˜æˆcurrentæ ‘  
  ![iberæ›´æ–°æœºåˆ¶05](./images/fiberæ›´æ–°æœºåˆ¶05.png)  

- åŒç¼“å†²æ ‘  
  canvasç»˜åˆ¶åŠ¨ç”»çš„æ—¶å€™ å¦‚æœä¸Šä¸€å¸§è®¡ç®—é‡æ¯”è¾ƒå¤§ å¯¼è‡´æ¸…é™¤ä¸Šä¸€å¸§ç”»é¢åˆ°ç»˜åˆ¶å½“å‰å¸§ç”»é¢ä¹‹é—´æœ‰è¾ƒé•¿é—´éš™ å°±ä¼šå‡ºç°ç™½å± ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ canvasåœ¨å†…å­˜ä¸­ç»˜åˆ¶å½“å‰åŠ¨ç”» ç»˜åˆ¶å®Œæ¯•åç›´æ¥ç”¨å½“å‰å¸§æ›¿æ¢ä¸Šä¸€å¸§ç”»é¢ ç”±äºçœå»äº†ä¸¤å¸§é—´çš„è®¡ç®—æ—¶é—´ ä¸ä¼šå‡ºç°ä»ç™½å±åˆ°å‡ºç°ç”»é¢çš„é—ªçƒæƒ…å†µ è¿™ç§åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯å«åšåŒç¼“å­˜  
  Reactç”¨workInProgressæ ‘(å†…å­˜ä¸­æ„å»ºçš„æ ‘)å’Œcurrentæ ‘(æ¸²æŸ“æ ‘)æ¥å®ç°æ›´æ–°é€»è¾‘ åŒç¼“å­˜ä¸€ä¸ªåœ¨å†…å­˜ä¸­æ„å»º ä¸€ä¸ªæ¸²æŸ“è§†å›¾ ä¸¤é¢—æ ‘ç”¨alternateæŒ‡é’ˆç›¸äº’æŒ‡å‘ åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ ç›´æ¥å¤ç”¨ç¼“å­˜æ ‘åšä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“æ ‘ ä¸Šä¸€æ¬¡çš„æ¸²æŸ“æ ‘åˆä½œä¸ºç¼“å­˜æ ‘ è¿™æ ·å¯ä»¥é˜²æ­¢åªç”¨ä¸€æ£µæ ‘æ›´æ–°çŠ¶æ€çš„ä¸¢å¤±æƒ…å†µ åˆåŠ å¿«äº†DOMèŠ‚ç‚¹çš„æ›¿æ¢ä¸æ›´æ–°  

### ä¸¤å¤§é˜¶æ®µ renderå’Œcommit  
renderé˜¶æ®µå’Œcommité˜¶æ®µæ˜¯æ•´ä¸ªfiber reconcilerçš„æ ¸å¿ƒ  
- renderé˜¶æ®µ  
  > react-reconciler/src/ReactFiberWorkLoop.js
  ```javascript
  function workLoop (){
    while (workInProgress !== null ) {
      workInProgress = performUnitOfWork(workInProgress);
    }
  }
  ```
  æ¯ä¸ªfiberå¯ä»¥çœ‹åšä¸€ä¸ªæ‰§è¡Œçš„å•å…ƒ åœ¨è°ƒå’Œè¿‡ç¨‹ä¸­ æ¯ä¸€ä¸ªå‘ç”Ÿæ›´æ–°çš„fiberéƒ½ä¼šä½œä¸ºä¸€æ¬¡workInProgress é‚£ä¹ˆworkLoopå°±æ˜¯æ‰§è¡Œæ¯ä¸€ä¸ªå•å…ƒçš„è°ƒåº¦å™¨ å¦‚æœæ¸²æŸ“æ²¡æœ‰è¢«ä¸­æ–­ é‚£ä¹ˆworkLoopä¼šéå†ä¸€éfiberæ ‘ performUnitOfWorkåŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µ beginWorkå’ŒcompleteWork  
  > react-reconciler/src/ReactFiberWorkLoop.js
  ```javascript
  function performUnitOfWork(){
    next = beginWork(current, unitOfWork, renderExpirationTime);
    if (next === null) {
       next = completeUnitOfWork(unitOfWork);
    }
  }
  ```
  beginWorkæ˜¯å‘ä¸‹è°ƒå’Œçš„è¿‡ç¨‹ æ˜¯ç”±fiberRootæŒ‰ç…§childæŒ‡é’ˆé€å±‚å‘ä¸‹è°ƒå’Œ æœŸé—´ä¼šæ‰§è¡Œå‡½æ•°ç»„ä»¶ å®ä¾‹åŒ–ç±»ç»„ä»¶ diffè°ƒå’Œå­èŠ‚ç‚¹ æ‰“ä¸åŒçš„effectTag  
  completeUnitOfWorkæ˜¯å‘ä¸Šå½’å¹¶çš„è¿‡ç¨‹ å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ ä¼šè¿”å›siblingå…„å¼Ÿ å¦‚æœæ²¡æœ‰ ä¼šè¿”å›returnçˆ¶çº§ ä¸€ç›´è¿”å›åˆ°fiberRoot æœŸé—´å¯ä»¥å½¢æˆeffectList å¯¹äºåˆå§‹åŒ–æµç¨‹ä¼šåˆ›å»ºDOM å¯¹äºDOMå…ƒç´ è¿›è¡Œäº‹ä»¶æ”¶é›† å¤„ç†style classNameç­‰  
  è¿™ä¹ˆä¸€ä¸Šä¸€ä¸‹ æ„æˆäº†æ•´ä¸ªfiberæ ‘çš„è°ƒå’Œ  
  - å‘ä¸‹è°ƒå’ŒbeginWork  
    > react-reconciler/src/ReactFiberBeginWork.js
    ```javascript
    function beginWork(current,workInProgress){
        switch(workInProgress.tag){
        case IndeterminateComponent:{// åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ 
            //....
        }
        case FunctionComponent: {//å¯¹åº”å‡½æ•°ç»„ä»¶
            //....
        }
        case ClassComponent:{  //ç±»ç»„ä»¶
            //...
        }
        case HostComponent:{
            //...  
        }
        ...
      }
    }
    ```
    æ€»ç»“beginWorkä½œç”¨å¦‚ä¸‹  
    - å¯¹äºç»„ä»¶ æ‰§è¡Œéƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸ æ‰§è¡Œrender å¾—åˆ°æœ€æ–°çš„children  
    - å‘ä¸‹éå†è°ƒå’Œchildren å¤ç”¨oldFiber(diffç®—æ³•)  
    - æ‰“ä¸åŒçš„å‰¯ä½œç”¨æ ‡ç­¾effectTag æ¯”å¦‚ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ æˆ–è€…å…ƒç´ çš„å¢åŠ åˆ é™¤æ›´æ–°  
  - reconcileChildren  
    Reactæ˜¯å¦‚ä½•è°ƒå’Œå­èŠ‚ç‚¹çš„  
    > react-reconciler/src/ReactFiberBeginWork.js
    ```javascript
    function reconcileChildren(current,workInProgress){
        if(current === null){  /* åˆå§‹åŒ–å­ä»£fiber  */
                workInProgress.child = mountChildFibers(workInProgress,null,nextChildren,renderExpirationTime)
        }else{  /* æ›´æ–°æµç¨‹ï¼Œdiff childrenå°†åœ¨è¿™é‡Œè¿›è¡Œã€‚ */
                workInProgress.child = reconcileChildFibers(workInProgress,current.child,nextChildren,renderExpirationTime)
        }
    }
    ```
  - å¸¸ç”¨çš„effectTag  
    ```javascript
    export const Placement = /*             */ 0b0000000000010;  // æ’å…¥èŠ‚ç‚¹
    export const Update = /*                */ 0b0000000000100;  // æ›´æ–°fiber
    export const Deletion = /*              */ 0b0000000001000;  // åˆ é™¤fiebr
    export const Snapshot = /*              */ 0b0000100000000;  // å¿«ç…§
    export const Passive = /*               */ 0b0001000000000;  // useEffectçš„å‰¯ä½œç”¨
    export const Callback = /*              */ 0b0000000100000;  // setStateçš„ callback
    export const Ref = /*                   */ 0b0000010000000;  // ref
    ```
  - å‘ä¸Šå½’å¹¶completeUnitOfWork  
    completeUnitOfWorkçš„æµç¨‹æ˜¯è‡ªä¸‹è€Œä¸Šçš„ ä¸»è¦å®Œæˆ  
    - é¦–å…ˆcompleteUnitOfWorkå°†effectTagçš„fiberèŠ‚ç‚¹ä¿å­˜åœ¨ä¸€æ¡è¢«ç§°ä¸ºeffectListçš„å•å‘é“¾è¡¨ä¸­ åœ¨commité˜¶æ®µ å°†ä¸å†éœ€è¦éå†æ¯ä¸€ä¸ªfiber åªéœ€è¦æ‰§è¡Œæ›´æ–°effectListå°±å¯ä»¥äº†  
    - completeWorké˜¶æ®µå¯¹äºç»„ä»¶å¤„ç†context å¯¹äºå…ƒç´ æ ‡ç­¾åˆå§‹åŒ– ä¼šåˆ›å»ºçœŸå®DOM å°†å­å­™DOMèŠ‚ç‚¹æ’å…¥åˆšç”Ÿæˆçš„DOMèŠ‚ç‚¹ä¸­ ä¼šè§¦å‘diffPropertieså¤„ç†props æ¯”å¦‚äº‹ä»¶æ”¶é›† style classNameå¤„ç†  
  - è°ƒå’Œé¡ºåº  
    ä¸Šè¿°demo åœ¨åˆå§‹åŒ–æˆ–è€…ä¸€æ¬¡æ›´æ–°ä¸­è°ƒå’Œçš„é¡ºåºæ˜¯æ€æ ·çš„  
    - beginWork -> rootFiber  
    - beginWork -> Index fiber  
    - beginWork -> div fiber  
    - beginwork -> hello,world fiber  
    - completeWork -> hello,world fiber(è¿”å›sibling)  
    - beginWork -> p fiber  
    - completeWork -> p fiber  
    - beginWork -> button fiber  
    - completeWork -> button fiber(æ­¤æ—¶æ²¡æœ‰sibling è¿”å›return)  
    - completeWork -> div fiber  
    - completeWork -> Index fiber  
    - completeWork -> rootFiber(å®Œæˆæ•´ä¸ªworkLoop)  
    > æ²¡æœ‰ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹å’Œ ç‚¹èµ çš„æ–‡æœ¬fiberçš„beginWork/completeWorkæµç¨‹ æ˜¯å› ä¸ºä½œä¸ºä¸€ç§æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ é’ˆå¯¹åªæœ‰å•ä¸€æ–‡æœ¬å­èŠ‚ç‚¹çš„fiber Reactä¼šç‰¹æ®Šå¤„ç†  
- commité˜¶æ®µ  
  commité˜¶æ®µè¦åšçš„äº‹æƒ…  
  - å¯¹ä¸€äº›ç”Ÿå‘½å‘¨æœŸå’Œå‰¯ä½œç”¨é’©å­çš„å¤„ç† æ¯”å¦‚componentDidMount å‡½æ•°ç»„ä»¶çš„useEffect useLayoutEffect  
  - åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ æ·»åŠ èŠ‚ç‚¹(Placement) æ›´æ–°èŠ‚ç‚¹(Update) åˆ é™¤èŠ‚ç‚¹(Deletion) è¿˜æœ‰ä¸€äº›ç»†èŠ‚çš„å¤„ç† æ¯”å¦‚refçš„å¤„ç†  
  commitå¯ä»¥ç»†åˆ†ä¸º  
  - before mutationé˜¶æ®µï¼ˆæ‰§è¡ŒDOMæ“ä½œå‰ï¼‰  
    > react-reconciler/src/ReactFiberWorkLoop.js
    ```javascript
    function commitBeforeMutationEffects() {
        while (nextEffect !== null) {
            const effectTag = nextEffect.effectTag;
            if ((effectTag & Snapshot) !== NoEffect) {
            const current = nextEffect.alternate;
            // è°ƒç”¨getSnapshotBeforeUpdates
            commitBeforeMutationEffectOnFiber(current, nextEffect);
            }
            if ((effectTag & Passive) !== NoEffect) {
            scheduleCallback(NormalPriority, () => {
                flushPassiveEffects();
                return null;
                });
            }
            nextEffect = nextEffect.nextEffect;
        }
    }
    ```
    before mutationé˜¶æ®µåšçš„äº‹ä¸»è¦æœ‰ä»¥ä¸‹å†…å®¹  
    - å› ä¸ºbefore mutationè¿˜æ²¡æœ‰ä¿®æ”¹çœŸå®çš„DOM æ˜¯è·å–DOMå¿«ç…§çš„æœ€ä½³æ—¶æœº å¦‚æœæ˜¯ç±»ç»„ä»¶æœ‰getSnapshotBeforeUpdate é‚£ä¹ˆä¼šæ‰§è¡Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸ  
    - ä¼šå¼‚æ­¥è°ƒç”¨useEffect é‡‡ç”¨å¼‚æ­¥è°ƒç”¨çš„ç›®çš„å°±æ˜¯é˜²æ­¢åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨åšè§†å›¾æ¸²æŸ“  
  - mutationé˜¶æ®µï¼ˆæ‰§è¡ŒDOMæ“ä½œï¼‰  
    ```javascript
    function commitMutationEffects(){
        while (nextEffect !== null) {
            if (effectTag & Ref) { /* ç½®ç©ºRef */
                const current = nextEffect.alternate;
                if (current !== null) {
                    commitDetachRef(current);
                }
            }
            switch (primaryEffectTag) {
                case Placement: {} //  æ–°å¢å…ƒç´ 
                case Update:{}     //  æ›´æ–°å…ƒç´ 
                case Deletion:{}   //  åˆ é™¤å…ƒç´ 
            }
        } 
    }
    ```
    mutationé˜¶æ®µåšçš„äº‹æœ‰ä»¥ä¸‹å†…å®¹  
    - ç½®ç©ºref  
    - å¯¹æ–°å¢å…ƒç´  æ›´æ–°å…ƒç´  åˆ é™¤å…ƒç´  è¿›è¡ŒçœŸå®çš„DOMæ“ä½œ  
  - layouté˜¶æ®µï¼ˆæ‰§è¡ŒDOMæ“ä½œåï¼‰  
    ```javascript
    function commitLayoutEffects(root){
        while (nextEffect !== null) {
            const effectTag = nextEffect.effectTag;
            commitLayoutEffectOnFiber(root,current,nextEffect,committedExpirationTime)
            if (effectTag & Ref) {
                commitAttachRef(nextEffect);
            }
        }
    }
    ```
    layouté˜¶æ®µDOMå·²ç»æ›´æ–°å®Œæ¯• è¿™ä¸ªé˜¶æ®µåšçš„äº‹æœ‰  
    - commitLayoutEffectOnFiberå¯¹äºç±»ç»„ä»¶ ä¼šæ‰§è¡Œç”Ÿå‘½å‘¨æœŸ setStateçš„Callback å¯¹äºå‡½æ•°ç»„ä»¶ä¼šæ‰§è¡ŒuseLayoutEffecté’©å­  
    - å¦‚æœæœ‰ref ä¼šé‡æ–°èµ‹å€¼ref
  commité˜¶æ®µæ€»ç»“ ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯æ‰§è¡ŒeffectList æ›´æ–°DOM æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ è·å–refç­‰æ“ä½œ

- è°ƒå’Œ+å¼‚æ­¥è°ƒåº¦æµç¨‹æ€»å›¾  
  ![è°ƒå’Œ+å¼‚æ­¥è°ƒåº¦æµç¨‹æ€»å›¾](./images/è°ƒå’Œ+å¼‚æ­¥è°ƒåº¦æµç¨‹æ€»å›¾.png)
