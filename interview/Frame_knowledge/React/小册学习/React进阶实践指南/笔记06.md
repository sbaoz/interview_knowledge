# 生命周期
- render阶段(调和)  
React在调和阶段会深度遍历fiber树 目的是发现不同(diff)  
不同的地方就是需要更新的地方 对于变化的组件 就会执行render函数
- commit阶段  
在一次调和过程完毕之后 进入commit阶段 创建修改真实的DOM节点  
  
- 重要概念  
1. instance：类组件对应实例  
2. workInProgress树：内存中正在构建的fiber树 反应了要刷新到屏幕的未来状态  
3. current树：当前屏幕上显示内容对应的fiber树  
4. Component：就是项目中的class组件  
5. nextProps：作为组件在一次更新中新的props  
6. renderExpirationTime：作为下一次渲染的过期时间  

### 类组件的生命周期
- 组件初始化  
    - render阶段  
        1. constructor
        2. getDerivedFromProps/componentWillMount
        3. render
    - commit阶段  
        4. componentDidMount  
    
> react-reconciler/src/ReactFiberBeginWork.js
```javascript
/* workloop React 处理类组件的主要功能方法 */
function updateClassComponent(){
    let shouldUpdate
    const instance = workInProgress.stateNode // stateNode 是 fiber 指向 类组件实例的指针。
     if (instance === null) { // instance 为组件实例,如果组件实例不存在，证明该类组件没有被挂载过，那么会走初始化流程
        constructClassInstance(workInProgress, Component, nextProps); // 组件实例将在这个方法中被new。
        mountClassInstance(  workInProgress,Component, nextProps,renderExpirationTime ); //初始化挂载组件流程
        shouldUpdate = true; // shouldUpdate 标识用来证明 组件是否需要更新。
     }else{  
        shouldUpdate = updateClassInstance(current, workInProgress, Component, nextProps, renderExpirationTime) // 更新组件流程
     }
     if(shouldUpdate){
         nextChildren = instance.render(); /* 执行render函数 ，得到子节点 */
        reconcileChildren(current,workInProgress,nextChildren,renderExpirationTime) /* 继续调和子节点 */
     }
}
```

- 组件更新  
    - render阶段  
      1. getDerivedStateFromProps/componentWillReceiveProps  
      2. shouldComponentUpdate  
      3. componentWillUpdate  
      4. render  
    - commit阶段  
      5. getSnapshotBeforeUpdate  
      6. componentDidUpdate  

> react-reconciler/src/ReactFiberClassComponent.js
```javascript
function updateClassInstance(current,workInProgress,ctor,newProps,renderExpirationTime){
    const instance = workInProgress.stateNode; // 类组件实例
    const hasNewLifecycles =  typeof ctor.getDerivedStateFromProps === 'function'  // 判断是否具有 getDerivedStateFromProps 生命周期
    if(!hasNewLifecycles && typeof instance.componentWillReceiveProps === 'function' ){
         if (oldProps !== newProps || oldContext !== nextContext) {     // 浅比较 props 不相等
            instance.componentWillReceiveProps(newProps, nextContext);  // 执行生命周期 componentWillReceiveProps 
         }
    }
    let newState = (instance.state = oldState);
    if (typeof getDerivedStateFromProps === 'function') {
        ctor.getDerivedStateFromProps(nextProps,prevState)  /* 执行生命周期getDerivedStateFromProps  ，逻辑和mounted类似 ，合并state  */
        newState = workInProgress.memoizedState;
    }   
    let shouldUpdate = true
    if(typeof instance.shouldComponentUpdate === 'function' ){ /* 执行生命周期 shouldComponentUpdate 返回值决定是否执行render ，调和子节点 */
        shouldUpdate = instance.shouldComponentUpdate(newProps,newState,nextContext,);
    }
    if(shouldUpdate){
        if (typeof instance.componentWillUpdate === 'function') {
            instance.componentWillUpdate(); /* 执行生命周期 componentWillUpdate  */
        }
    }
    return shouldUpdate
}
```
> react-reconciler/src/ReactFiberCommitWork.js
```javascript
function commitBeforeMutationLifeCycles(current,finishedWork){
     switch (finishedWork.tag) {
          case ClassComponent:{
               const snapshot = instance.getSnapshotBeforeUpdate(prevProps,prevState) /* 执行生命周期 getSnapshotBeforeUpdate   */
                instance.__reactInternalSnapshotBeforeUpdate = snapshot; /* 返回值将作为 __reactInternalSnapshotBeforeUpdate 传递给 componentDidUpdate 生命周期  */
          }
     }
}
```

- 组件销毁  

