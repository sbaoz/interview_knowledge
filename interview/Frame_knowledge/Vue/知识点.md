### 用Jest测试单文件组件    
- 安装Jest  
1.首先通过vue-cli创建了模板脚手架  
2.然后安装Jest和Vue Test Utils
```shell
npm install -D jest @vue/test-utils
```
3.在package.json中定义一个单元测试的脚本  
```json
{
  "scripts": {
    "test": "jest"
  }
}
```
- 浏览器环境  
Jest自带 其他的测试运行器需要安装以下依赖
```shell
npm install -D jsdom jsdom-global
```
- 在Jest中处理单文件组件  
1.为了告诉Jest如何处理*.vue文件 需要安装和配置vue-jest预处理器  
```shell
npm install -D vue-jest
```
2.在package.json中创建一个jest块  
```json
{
  // ...
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      // 告诉Jest处理`*.vue`文件
      "vue"
    ],
    "transform": {
      // 用`vue-jest`处理`*.vue`文件  
      ".*\\.(vue)$": "vue-jest"
    }
  }
}
```
> 注意：vue-jest 目前并不支持 vue-loader 所有的功能，比如自定义块和样式加载。额外的，诸如代码分隔等 webpack 特有的功能也是不支持的。如果要使用这些不支持的特性，你需要用 Mocha 取代 Jest 来运行你的测试，同时用 webpack 来编译你的组件  
> 如果你使用了 Babel 7 或更高版本，你需要在你的 devDependencies 里添加 babel-bridge
- 处理webpack别名  
```json
{
  // ...
  "jest": {
    // ...
    // 支持源代码中相同的`@`->`src`别名
    "moduleNameMapper": {
      "^@/(.*)$": "<rootDir>/src/$1"
    }
  }
}
```
- 为Jest配置Babel  
1.为了能在测试中使用ES modules语法和stage-x的特性 需要安装babel-jest  
```shell
npm install -D babel-jest
```
2.在package.json的jest.transform里添加一个入口 来告诉Jest用babel-jest处理JavaScript测试文件  
```json
{
  // ...
  "jest": {
    // ...
    "transform": {
      // ...
      // 用`babel-jest`处理js
      "^.+\\.js$": "<rootDir>/node_modules/babel-jest"
    }
  }
}
```
3.修改babel配置  
```json
{
  "presets": [["env", { "modules": false }]],
  "env": {
    "test": {
      "presets": [["env", { "targets": { "node": "current" } }]]
    }
  }
}
```
- 放置测试文件  
默认情况下 Jest会递归找到整个工程里所有.spec.js或.test.js扩展名的文件 也可以在package.json里的配置段落中改变它的testRegex  
Jest推荐在被测试代码的所在目录下创建一个__tests__目录  
- 测试覆盖率  
扩展collegeCoverage选项 然后添加collectCoverageFrom数组来定义需要收集的覆盖率信息的文件  
```json
{
  "jest": {
    // ...
    "collectCoverage": true,
    "collectCoverageFrom": ["**/*.{js,vue}", "!**/node_modules/**"]
  }
}
```
这样会开启默认格式的测试覆盖率报告 可以通过coverageReporters选项来定制它们  
```json
{
  "jest": {
    // ...
    "coverageReporters": ["html", "text-summary"]
  }
}
```
- 快照测试  
  当使用Vue Test Utils挂载一个组件时 可以访问都HTML根元素 这可以保存为一个快照为Jest快照测试使用  
```javascript
test('renders correctly', () => {
  const wrapper = mount(Component)
  expect(wrapper.element).toMatchSnapshot()
})
```
通过一个自定义的序列化工具改进被保存的快照  
```shell
npm install --save-dev jest-serializer-vue
```
然后在package.json中配置它  
```json
{
  // ...
  "jest": {
    // ...
    // 快照的序列化工具
    "snapshotSerializers": ["jest-serializer-vue"]
  }
}
```
- 踩坑  
1.无法识别babel.config.js的配置  
  @vue/cli-plugin-babel依赖的babel-core为babel-core@^7.0.0-bridge.0，babel7以下的都无法识别  
  需要安装  
  ```shell
  npm i -D babel-core@^7.0.0-bridge.0 
  ```
[Jest配置文档](https://jestjs.io/zh-Hans/docs/configuration#collectcoverage-boolean)
[Jest断言API](https://jestjs.io/zh-Hans/docs/expect)
