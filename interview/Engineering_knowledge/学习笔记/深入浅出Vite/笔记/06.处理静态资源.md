<!--
 * @Author: sbaoz xiaojz821@hotmail.com
 * @Date: 2022-07-13 15:23:08
 * @LastEditors: sbaoz xiaojz821@hotmail.com
 * @LastEditTime: 2022-07-14 17:27:01
 * @FilePath: \interview_knowledge\interview\Engineering_knowledge\学习笔记\深入浅出Vite\笔记\06.处理静态资源.md
 * @Description: Vite 如何加载静态资源和如何在生产环境中对静态资源进行优化。
 * 如何加载各种静态资源，如图片、svg(组件形式)、JSON、Web Worker 脚本、Web Asssembly 文件等等格式
 * 生产环境，对自定义部署域名、是否应该内联、图片压缩、svg雪碧图等问题进行了详细的探讨和实践
 * 如何定义环境变量文件、如何使用 Glob 导入的语法糖
-->
#### 图片加载
三种加载图片的场景  
1. 在HTML或者JSX中 通过img标签加载图片
```html
<img src="../../assets/a.png"></img>
```
2. 在CSS中通过background属性加载图片
```css
background: url('../../assets/b.png') norepeat;
```
3. 在JavaScript中 通过脚本动态指定图片的src属性
```ts
document.getElementById('hero-img').src = '../../assets/c.png'
```
#### SVG组件方式加载
通常希望能将svg当做一个组件来引入 这样可以方便的修改svg的各种属性  
在不同的框架下需要安装对应的插件  
Vue2: [vite-plugin-vue2-svg](https://github.com/pakholeung37/vite-plugin-vue2-svg)  
Vue3: [vite-svg-loader](https://github.com/jpkleemans/vite-svg-loader)  
React: [vite-plugin-svgr](https://github.com/pd4d10/vite-plugin-svgr)  
在vite.config.ts中添加插件
在tsconfig.json中添加配置  
```json
{
  "compilerOptions": {
    // 省略其它配置
    "types": ["vite-plugin-svgr/client"]
  }
}
```
#### JSON加载
Vite中已经内置了对于JSON文件的解析 底层使用@rollup/pluginutils 的 dataToEsm 方法将 JSON 对象转换为一个包含各种具名导出的 ES 模块  
可以在vite.config.ts配置文件禁用按名导入的方式 在JSON数据量比较大的时候 可以优化性能  
```ts
{
  json: {
    stringify: true
  }
}
```
#### Web Worker脚本
在组件中引入的时候注意加上?worker后缀
#### Web Assembly文件
WASM是一种将用一种编程语言编写的代码转换为浏览器可理解的机器代码的技术  
Vite对于.wasm文件开箱即用  
Vite 会对.wasm文件的内容进行封装，默认导出为 init 函数，这个函数返回一个 Promise，因此我们可以在其 then 方法中拿到其导出的成员  
#### 其他静态资源
Vite 也对下面几类格式提供了内置的支持:  
- 媒体类文件，包括mp4、webm、ogg、mp3、wav、flac和aac。
- 字体类文件。包括woff、woff2、eot、ttf 和 otf。
- 文本类。包括webmanifest、pdf和txt。  

如果项目中还存在其它格式的静态资源，可以通过修改vite.config.ts中的assetsInclude配置让 Vite 来支持加载  
```ts
{
  assetsInclude: ['.gltf']
}
```
#### 特殊资源处理
Vite 中引入静态资源时，也支持在路径最后加上一些特殊的 query 后缀，包括:  
- ?url: 表示获取资源的路径，这在只想获取文件路径而不是内容的场景将会很有用。
- ?raw: 表示获取资源的字符串内容，如果你只想拿到资源的原始内容，可以使用这个后缀。
- ?inline: 表示资源强制内联，而不是打包成单独的文件。

### 生产环境处理
#### 自定义部署域名
区分静态资源生产环境和开发环境 在vite.config.ts配置文件中指定base参数即可  
注意在项目根目录新增的两个环境变量文件.env.development和.env.production 分别在开发环境和生产环境注入一些环境变量 比如NODE_ENV  
有时候可能项目中的某些图片需要存放到另外的存储服务 可以通过定义环境变量的方式来解决这个问题 在项目根目录新增.env文件 并注入环境变量  
然后在vite-env.d.ts文件中增加类型声明 在组件中使用这个环境变量即可  
开发环境优先级: .env.development > .env  
生产环境优先级: .env.production > .env  
#### 内联还是单文件
Vite中静态资源有两种构建方式 单文件或者通过base64编码内嵌到代码中  
对于较小的资源 适合内联到代码中  
- 对代码体积影响小
- 减少不必要的网络请求 优化网络性能

对于比较大的资源 单独打包成一个文件  
Vite 中内置的优化方案是下面这样的:  
- 如果静态资源体积 >= 4KB，则提取成单独的文件
- 如果静态资源体积 < 4KB，则作为 base64 格式的字符串内联

可以修改vite.config.ts中的build.assetsInlineLimit配置临界值  
svg 格式的文件不受这个临时值的影响，始终会打包成单独的文件，因为它和普通格式的图片不一样，需要动态设置一些属性  
#### 图片压缩
```
pnpm i vite-plugin-imagemin -D // 安装图片压缩插件
```
安装的时候卡主的话 加个hosts试试 199.232.4.133 raw.githubusercontent.com
在vite.config.ts中添加相关配置  
#### SVG雪碧图优化
Vite会把svg图标始终打包成单文件 大量的svg图标会导致网络请求增加 可以通过合并图标的方式解决
```
pnpm i vite-plugin-svg-icons -D // 安装插件
```
在vite.config.ts中添加相关配置  
新建雪碧图组件 src/components/SvgIcon  
在src/main.tsx文件中添加一行代码 import 'virtual:svg-icons-register';  
将所有的svg合并到一个雪碧图中 通过use属性来引用雪碧图的对应内容 减少大量svg的网络请求
