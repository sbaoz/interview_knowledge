#### Rollup
- 基于ES Module模块规范实现的JavaScript打包工具 Vite构建的基石
- 具有天然的Tree Shaking功能

#### 常用配置
- 多产物配置  
  通常需要对外暴露不同格式的产物供他人使用（ESM, CommonJS, UMD等格式） 保证良好的兼容性
  ```javascript
    // rollup.config.js
    /**
    * @type { import('rollup').RollupOptions }
    */
    const buildOptions = {
    input: ["src/index.js"],
    // 将 output 改造成一个数组
    output: [
        {
        dir: "dist/es",
        format: "esm",
        },
        {
        dir: "dist/cjs",
        format: "cjs",
        },
    ],
    };

    export default buildOptions;
  ```
- 多入口配置  
  通常和多产物结合使用
  ```javascript
    {
        input: ["src/index.js", "src/util.js"]
    }
    // 或者
    {
        input: {
            index: "src/index.js",
            util: "src/util.js",
        },
    }
  ```
  不同入口对应的打包配置不一样 可以默认导出一个配置数组  
  ```javascript
    // rollup.config.js
    /**
    * @type { import('rollup').RollupOptions }
    */
    const buildIndexOptions = {
    input: ["src/index.js"],
    output: [
        // 省略 output 配置
    ],
    };

    /**
    * @type { import('rollup').RollupOptions }
    */
    const buildUtilOptions = {
    input: ["src/util.js"],
    output: [
        // 省略 output 配置
    ],
    };

    export default [buildIndexOptions, buildUtilOptions];
  ```
- 自定义output配置  
  ```javascript
  output: {
        // 产物输出目录
        dir: path.resolve(__dirname, 'dist'),
        // 以下三个配置项都可以使用这些占位符:
        // 1. [name]: 去除文件后缀后的文件名
        // 2. [hash]: 根据文件名和文件内容生成的 hash 值
        // 3. [format]: 产物模块格式，如 es、cjs
        // 4. [extname]: 产物后缀名(带`.`)
        // 入口模块的输出文件名
        entryFileNames: `[name].js`,
        // 非入口模块(如动态 import)的输出文件名
        chunkFileNames: 'chunk-[hash].js',
        // 静态资源文件输出文件名
        assetFileNames: 'assets/[name]-[hash][extname]',
        // 产物输出格式，包括`amd`、`cjs`、`es`、`iife`、`umd`、`system`
        format: 'cjs',
        // 是否生成 sourcemap 文件
        sourcemap: true,
        // 如果是打包出 iife/umd 格式，需要对外暴露出一个全局变量，通过 name 配置变量名
        name: 'MyBundle',
        // 全局变量声明
        globals: {
            // 项目中可以直接用`$`代替`jquery`
            jquery: '$'
        }
    }
  ```
- 依赖 external  
  第三方包不进行打包 可以通过external进行外部化 在SSR构建或者使用ESM CDN的场景中非常有用  
   ```javascript
    {
        external: ['react', 'react-dom']
    }
   ```
- 接入插件能力  
  解决Rollup本身不支持的场景  
  ```javascript
  // rollup.config.js
    import { terser } from 'rollup-plugin-terser'
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";

    export default {
    output: {
        // 加入 terser 插件，用来压缩代码
        plugins: [terser()]
    },
    plugins: [resolve(), commonjs()]
    }
  ```
  output.plugins中配置的插件是有一定限制的，只有使用Output 阶段相关钩子的插件才能够放到这个配置中  
  常用的插件  
  - @rollup/plugin-node-resolve：是为了允许我们加载第三方依赖，否则像import React from 'react' 的依赖导入语句将不会被 Rollup 识别  
  - @rollup/plugin-commonjs：作用是将 CommonJS 格式的代码转换为 ESM 格式
  - @rollup/plugin-json： 支持.json的加载，并配合rollup的Tree Shaking机制去掉未使用的部分，进行按需打包
  - @rollup/plugin-babel：在 Rollup 中使用 Babel 进行 JS 代码的语法转译
  - @rollup/plugin-typescript: 支持使用 TypeScript 开发
  - @rollup/plugin-alias：支持别名配置
  - @rollup/plugin-replace：在 Rollup 进行变量字符串的替换
  - rollup-plugin-visualizer: 对 Rollup 打包产物进行分析，自动生成产物体积可视化分析图

#### JavaScript API方式调用  
基于Rollup定制一些打包过程 主要分为rollup.rollup和rollup.watch两个API  
- rollup.rollup  
  用来一次性的进行Rollup打包 参考build.js
- rollup.watch  
  每次源文件变动后自动进行重新打包 参考watch.js