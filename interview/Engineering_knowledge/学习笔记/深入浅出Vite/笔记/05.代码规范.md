<!--
 * @Author: sbaoz xiaojz821@hotmail.com
 * @Date: 2022-07-12 17:37:41
 * @LastEditors: sbaoz xiaojz821@hotmail.com
 * @LastEditTime: 2022-07-13 15:22:24
 * @FilePath: \interview_knowledge\interview\Engineering_knowledge\学习笔记\深入浅出Vite\笔记\05.代码规范.md
 * @Description: 代码规范配置
 * 前端的自动化代码规范工具的使用以及在 Vite 中的接入方法
 * JavaScript/TypeScript 规范。主流的 Lint 工具包括 Eslint、Prettier
 * 样式开发规范。主流的 Lint 工具包括Stylelint、Prettier
 * Git 提交规范。主流的 Lint 工具包括Commitlint
 * 通过编辑器的插件或者 Vite 插件在开发阶段暴露出规范问题，但也无法保证这类问题在开发时完全被解决掉，因此我们尝试在代码提交阶段来解决这个问题，通过Husky+lint-staged成功地拦截 git commit过程，只有在各项 Lint 检查通过后才能正常提交代码，这样就有效提高了线上代码和 Git 提交信息的质量
-->
### 代码规范
#### 接入ESLint
ESLint的主要优势在于代码的风格检查并给出提示  
```
pnpm i eslint -D // 安装ESLint
npx eslint --init // 执行初始化命令  
pnpm i eslint-plugin-react@latest @typescript-eslint/eslint-plugin@latest @typescript-eslint/parser@latest -D // 手动安装依赖  
```
配置说明参考配置文件 .eslintrc.js  
[ESLint规则配置文档](https://cn.eslint.org/docs/rules/)  
#### 结合Prettier
Prettier提供更专业的代码格式化  
```
pnpm i prettier -D // 安装prettier
```  
在项目根目录新建.prettierrc.js配置文件  
```
pnpm i eslint-config-prettier eslint-plugin-prettier -D // 安装集成工具包
```
eslint-config-prettier用来覆盖 ESLint 本身的规则配置  
eslint-plugin-prettier则是用于让 Prettier 来接管eslint --fix即修复代码的能力  
修改 .eslintrc.js 加入prettier相关的配置  
可以在vscode中安装ESLint和Prettier插件  
在package.json中定义脚本  
```
"lint:script": "eslint --ext .js,.jsx,.ts,.tsx --fix --quiet ./"
```
#### 在Vite中接入ESLint
在开发阶段进行 ESLint 扫描，以命令行的方式展示出代码中的规范问题，并能够直接定位到原文件  
```
pnpm i vite-plugin-eslint -D // 安装插件
```  
在vite.config.ts中接入  
插件用另外一个进程运行ESLint扫描工作 不会影响Vite的启动速度  
#### 接入样式规范
使用Stylelint配合prettier  
```
pnpm i stylelint stylelint-prettier stylelint-config-prettier stylelint-config-recess-order stylelint-config-standard stylelint-config-standard-scss -D // 安装stylelint以及相关工具
```  
在项目根目录新建.stylelintrc.js配置文件  
可以在vscode中安装Stylelint插件  
在package.json中定义脚本  
```
"lint:style": "stylelint --fix \"src/**/*.{css,scss}\""
```
#### 在Vite中接入Stylelint
```
pnpm i @amatlash/vite-plugin-stylelint -D // 安装插件
```
在vite.config.ts中接入  
### Git提交工作流集成
#### 提交前的代码Lint检查
在代码提交的时候进行卡点检查，也就是拦截 git commit 命令，进行代码格式检查，只有确保通过格式检查才允许正常提交代码  
```
pnpm i husky -D // 安装Husky
```  
Husky 4.x以下的版本 只要在package.json中配置husky的钩子  
```json
{
  "husky": {
    "pre-commit": "npm run lint"
  }
}
```
在新的Husky版本中  
1. 初始化Husky: npx husky install 并将husky install作为项目启动前脚本  
```json
{
  "scripts": {
    // 会在安装 npm 依赖后自动执行
    "postinstall": "husky install"
  }
}
```
2. 添加Husky钩子 在终端执行
```
npx husky add .husky/pre-commit "npm run lint"
```
在项目根目录的.husky目录中看到名为pre-commit的文件，里面包含了 git commit前要执行的脚本。现在，当你执行 git commit 的时候，会首先执行 npm run lint脚本，通过 Lint 检查后才会正式提交代码记录  

添加lint-staged 解决Husky每次执行npm run lint时都对仓库中的代码进行全量扫描的问题 实现只对存入暂存区的文件进行Lint检查  
```
pnpm i -D lint-staged // 安装lint-staged
```  
在package.json中添加配置  
```json
{
  "lint-staged": {
    "**/*.{js,jsx,tsx,ts}": [
      "npm run lint:script",
      "git add ."
    ],
    "**/*.{scss}": [
      "npm run lint:style",
      "git add ."
    ]
  }
}
```
在Husky中应用lint-staged 在.husky/pre-commit脚本中，将原来的npm run lint换成如下脚本:
```
npx --no -- lint-staged
```
实现了提交代码时的增量 Lint 检查
#### 提交时的commit信息规范
Git 提交信息的规范也是不容忽视的一个环节，规范的 commit 信息能够方便团队协作和问题定位  
```
pnpm i commitlint @commitlint/cli @commitlint/config-conventional -D // 安装工具库
```
根目录下新建.commitlintrc.js  
将commitlint集成到Husky的钩子中 在终端执行  
```
npx husky add .husky/commit-msg "npx --no-install commitlint -e $HUSKY_GIT_PARAMS"
```  
在.husky目录下多出了commit-msg脚本文件，表示commitlint命令已经成功接入到 husky 的钩子当中